<!DOCTYPE html>
<html>
<head>
	<title>WebView Interaction</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		html, body {margin: 0; height: 100%; overflow-x:hidden;}
		@font-face {
			font-family: 'main';
			src: url('fonts/InriaSans.ttf');
		}
		.block{
			display:block;
			width:100%;
			height:100%;
			overflow: hidden;
		}
		.top-container{
			display: flex;
			flex-wrap: nowrap;
			background: #477BFF;
			align-content: center;
			align-items: center;
			justify-content: center;
		}
		.title{
			display: flex;
			font-family: main;
			font-size: 30px;
			margin: 30px;
			color:white;
			letter-spacing: 6px;
		}
		.main-button-container{
			display: flex;
			flex-wrap: nowrap;
			justify-content: center;
			margin: 30px;
		}
		.button{
			display: flex;
			background: #477BFF;
			border-radius: 15px;
			margin: 15px;
		}
		.button-img{
			width: 40px;
			height: 40px;
			margin: 15px;
		}
		.line{
			display: flex;
			background: #477BFF;
			width: 80%;
			height: 10px;
			margin-left: auto;
			margin-right: auto;
			border-radius: 10px;
		}
		.files-container{
			display: flex;
			flex-flow: column;
			margin: 30px 20px 0px 20px;
			height: 450px;
			overflow-y: scroll;
		}
		.files-container::-webkit-scrollbar {
		  width: 5px;
		}
		.files-container::-webkit-scrollbar-track {
		  background: white;
		}
		.files-container::-webkit-scrollbar-thumb {
		  background-color: #477BFF;
		  border-radius: 20px;
		}
		.file{
			display: flex;
			margin: 0px;
			align-items: center;
		}
		.file-img{
			width: 45px;
			height: 45px;
			margin: 15px;
			border-radius: 15px;
			background: #477BFF;
			padding: 10px;
		}
		.file-title{
			display: flex;
			font-family: arial;
			font-size: 18px;
			margin: 10px;
			color:grey;
			font-weight: bold;
			letter-spacing: 5px;
		}
		.no-files{
			display: flex;
			font-family: arial;
			font-size: 30px;
			margin: 30px;
			color:grey;
			font-weight: bold;
			letter-spacing: 5px;
			text-align: center;

			margin-left: auto;
			margin-right: auto;
		}
		.block{
			display: none;
		}
		#main-block{
			display: block;
		}
		.button-img-back{
			left: 10px;
			width: 40px;
			height: 40px;
		}
		.name-container{
			display: flex;
			flex-wrap: nowrap;
			background: #477BFF;
			align-content: center;
			align-items: center;
			justify-content: center;
			width: 290px;
			height: 350px;
			margin: auto;
			margin-top:120px;
			border-radius: 15px;
			flex-flow: column;
		}
		.settings-container{
			display: none;
			background: #477BFF;
			align-content: center;
			align-items: center;
			justify-content: center;
			width: 90%;
			height: 360px;
			top: 50%;
			left: 50%;
			position: absolute;
			border-radius: 20px;
			transform:translate(-50%, -50%);
			flex-flow: column;

		}
		.exit-container{
			display: none;
			background: #477BFF;
			align-content: center;
			align-items: center;
			justify-content: center;
			width: 90%;
			height: 360px;
			border-radius: 20px;
			top: 50%;
			left: 50%;
			position: absolute;
			flex-flow: column;
			transform:translate(-50%, -50%);
		}
		.button-settings{
			display: flex;
			background: white;
			padding: 10px;
			border-radius: 10px;
			align-content: center;
			align-items: center;
			margin: 5px;
			justify-content: center;
			width: 270px;
			height: 40px;
			font-weight: bold;
			font-family: arial;
		}
		.enter-button{
			display: flex;
			background: white;
			padding: 15px;
			border-radius: 10px;
			align-content: center;
			align-items: center;
			margin: 5px;
			justify-content: center;
			width: 30px;
			height: 30px;
		}
		.button-delete{
			margin-top:40px;
			background: red;
			color: white;
			display: flex;
			padding: 10px;
			border-radius: 10px;
			align-content: center;
			align-items: center;
			margin: 10px;
			justify-content: center;
			font-weight: bold;
			font-family: arial;
			width: 270px;
			height: 35px;
		}
		.change-title-container{
			display: flex;
			flex-wrap: nowrap;
			flex-flow: row;
		}
		.name-file-input{
			display: flex;
			background: white;
			border-radius: 10px;
			width: 200px;
			height: 40px;
			padding: 10px;
			font-size: 15px;
			color:grey;
			border: 0;
			font-family: arial;
			font-weight: bold;
			margin: 5px;
		}
		.name-input{
			display: flex;
			background: white;
			border-radius: 10px;
			width: 180px;
			height: 40px;
			padding: 10px;
			font-size: 15px;
		}
		.name-button{
			font-family: arial;
			letter-spacing: 2px;
			font-weight: bold;
			display: flex;
			background: white;
			color:#477BFF;
			width: 200px;
			height: 60px;
			font-size: 15px;
			margin: 20px;
			border-radius: 10px;

			align-content: center;
			align-items: center;
			justify-content: center;
		}
		.vertical-line{
			display: flex;
			background: white;
			border-radius: 20px;
			width: 7px;
			height: 10px;
			margin-left: 5px;
			margin-right: 5px;
		}
		.workzone{
			display: flex;
			margin: 0;
			background: grey;
			align-content: center;
			align-items: center;
			justify-content: center;
			flex-flow: column;
			padding: 10px;
		}
		.list{
			display: flex;
			margin: 10px;
			width: 300px;
			height: 400px;
			background: white;
		}
	</style>
</head>
<body>
<div class="block" id="main-block">
	<div class="top-container">
		<div class="title">NoteWorld</div>
	</div>
	<div class="main-button-container">
		<div class="button">
			<a href="create.html"><img class="button-img" src="img/addFile.png"></a>
		</div>
		<div class="button">
			<a href="download.html"><img class="button-img" src="img/downloadFile.png"></a>
		</div>
		<div class="button">
			<a href="upload.html"><img class="button-img" src="img/uploadFile.png"></a>
		</div>
	</div>
	<div class="line"></div>
	<div class="files-container" id="files-container">
		<!-- Список файлов -->
	</div>
</div>

<div class="block" id="file-block" style="display: none;">
	<div class="top-container">
		<img class="button-img" src="img/back.png" onclick="saveWindow()">
		<div class="vertical-line"></div>
		<img class="button-img" src="img/text.png" onclick="changeInstrument(0)">
		<img class="button-img" src="img/figure.png" onclick="changeInstrument(1)">
		<img class="button-img" src="img/pen.png" onclick="changeInstrument(2)">
		<div class="vertical-line"></div>
		<img class="button-img" src="img/settings.png" onclick="settings()">
	</div>
	<div class="exit-container" id="exit">
		<div class="button-settings" onclick="save(true)">Сохранить</div>
		<div class="button-delete" onclick="save(false)">Не сохранять</div>
	</div>
	<div class="settings-container" id="settings">
		<div class="change-title-container">
			<input class="name-file-input" id="name-file-input" placeholder="Введите новое название">
			<img class="button-img enter-button" src="img/enter.png" onclick="changeTitle()">
		</div>
		<div class="button-delete" onclick="deleteFile()">Удалить файл</div>
	</div>
	<div class="workzone">
		<canvas class="list" id="textCanvas" width="520" height="400"></canvas>
	</div>
</div>

<script>
	var files = [];           // Массив файлов
    var title = "";           // Текущий заголовок файла (с расширением)
    var isFileModified = false; // Флаг для отслеживания изменений в файле
    var newTitle = "";        // Переменная для временного хранения нового названия файла
    var data = [];            // Данные файла, которые могут быть изменены (тексты и координаты)
    let selectedTextIndex = null;  // Индекс редактируемого текста

    const canvas = document.getElementById('textCanvas');
    const ctx = canvas.getContext('2d');

    const textArea = {
        x: 10,
        y: 10,
        width: 500,  // Расширили ширину
        height: 380
    }; // Определённая область для текста

    let textContent = ""; // Весь текст
    let cursorPosition = textContent.length;  // Позиция курсора
    let inputActive = false;  // Флаг активности ввода
    let cursorVisible = true;  // Видимость курсора
    let lines = [];  // Массив строк текста

	ctx.font = '18px Arial'; // Устанавливаем нормальный шрифт и размер
	ctx.scale(1, 1);  // Масштабирование по обеим осям для предотвращения сжатия
	ctx.textBaseline = 'top'; // Базовая линия текста

    // Обновление canvas: текст и курсор
    function renderCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeRect(textArea.x, textArea.y, textArea.width, textArea.height);  // Отрисовка текстовой области
        let y = textArea.y + 10;  // Начальная позиция по Y

        // Отрисовка текста построчно
        lines.forEach(line => {
            ctx.fillText(line, textArea.x + 5, y);
            y += 20;
        });

        // Если курсор активен, отрисовываем его
        if (inputActive && cursorVisible) {
            const cursorX = textArea.x + 5 + ctx.measureText(lines[lines.length - 1] || "").width;
            const cursorY = textArea.y + (lines.length - 1) * 20 + 10;
            ctx.fillRect(cursorX, cursorY, 2, 18); // Отрисовка курсора
        }
    }

    // Анимация мигания курсора
    setInterval(() => {
        if (inputActive) {
            cursorVisible = !cursorVisible;
            renderCanvas();
        }
    }, 500);

    // Функция переноса текста на новую строку
    function wrapText(text) {
        lines = [];
        const paragraphs = text.split('\n'); // Поддержка переносов строк
        paragraphs.forEach(paragraph => {
            let line = "";
            for (let i = 0; i < paragraph.length; i++) {
                line += paragraph[i];
                const testWidth = ctx.measureText(line).width;
                if (testWidth > textArea.width - 10) {
                    lines.push(line);  // Принудительный перенос длинного слова
                    line = "";  // Начинаем новую строку
                }
            }
            if (line !== "") {
                lines.push(line);  // Добавляем последнюю строку
            }
        });
    }

    // Обработка ввода текста
    window.addEventListener('keydown', (e) => {
        if (inputActive) {
            if (e.key === "Backspace") {
                textContent = textContent.slice(0, -1);  // Удаление последнего символа
            } else if (e.key === "Enter") {
                textContent += "\n";  // Добавляем перенос строки
            } else if (e.key.length === 1) {  // Ввод обычных символов
                textContent += e.key;
            }

            isFileModified = true;  // Указываем, что файл изменён
            wrapText(textContent);  // Обновляем текстовые строки
            renderCanvas();  // Перерисовываем canvas
        }
    });

    // Обработка клика по canvas
    canvas.addEventListener('click', () => {
        inputActive = true;  // Активируем режим ввода
        cursorPosition = textContent.length;  // Устанавливаем курсор в конец текста
        renderCanvas();
    });

    // Загрузка списка файлов
    function getFiles(files_temp) {
        var file_container = document.getElementById("files-container");
        var inner = "";
        if (files_temp.length === 0) {
            inner = '<div class="no-files">Нет файлов</div>';
        } else {
            for (var i = 0; i < files_temp.length; i++) {
                inner += '<div class="file"><img class="file-img" src="img/file.png" onclick="openFile(\'' + files_temp[i] + '\')"><div class="file-title">' + files_temp[i] + '</div></div>';
            }
        }
        file_container.innerHTML = inner;
        files = files_temp;
    }

    // Открытие файла
	function openFile(title_temp) {
		title = title_temp;  // Получаем текущее полное название файла с расширением
		isFileModified = false; // При открытии файла сбрасываем флаг изменений
		newTitle = ""; // Сбрасываем новое имя файла
		android.readFile(title); // Чтение файла через Android-интерфейс
		document.getElementById("main-block").style.display = "none";
		document.getElementById("file-block").style.display = "block";
		hideSaveWindow(); // Скрываем окно сохранения на случай, если оно было показано
	}

    // Открыть или скрыть настройки
    function settings() {
        var settingsBlock = document.getElementById("settings");
        settingsBlock.style.display = (settingsBlock.style.display === "flex") ? "none" : "flex";
    }

    // Функция для подтверждения изменения названия файла
    function changeTitle() {
        var new_title = document.getElementById("name-file-input").value;
        if (new_title !== "") {
            android.changeTitle(title, new_title);
            title = new_title + ".nw";
            // Отмечаем, что были внесены изменения
            isFileModified = true;

            // Закрываем окно настроек после изменения
            settings();
        }
    }

    // Удалить файл
    function deleteFile() {
        android.deleteFile(title); // Удаляем файл через Android-интерфейс
        closeEditor(); // Закрываем редактор и обновляем список файлов
    }

    // Смена инструмента редактирования (например, карандаш, фигуры и т.д.)
    function changeInstrument(id) {
        isFileModified = true; // Любое действие в редакторе фиксируется как изменение
    }

    // Открыть окно с вопросом о сохранении (если были изменения)
    function saveWindow() {
        if (isFileModified) {
            document.getElementById("exit").style.display = "flex"; // Показываем окно сохранения
            document.getElementById("settings").style.display = "none"; // Скрываем настройки
        } else {
            closeEditor(); // Если изменений не было, просто закрываем редактор
        }
    }

    // Сохраняет текст из Canvas в JSON-файл
	function save(param) {
		if (param) {
			const jsonData = {
				type: "nodeworldfile",
				version: "1.0",
				objects: lines  // Массив строк текста из Canvas
			};
			android.writeFile(title, JSON.stringify(jsonData));  // Сохраняем JSON-данные
		}
		document.getElementById("file-block").style.display = "none";
        document.getElementById("main-block").style.display = "block";
        android.getAllJsonFiles();  // Обновление списка файлов после сохранения
        closeEditor();  // Закрываем редактор после сохранения или отмены
	}

    // Закрыть редактор и вернуться к списку файлов
    function closeEditor() {
        document.getElementById("file-block").style.display = "none"; // Закрыть блок редактора
        document.getElementById("main-block").style.display = "block"; // Показать основной блок
        android.getAllJsonFiles();  // Обновление списка файлов через Android-интерфейс
        isFileModified = false; // Сбрасываем флаг изменений
        newTitle = ""; // Сбрасываем новое имя файла
        hideSaveWindow(); // Закрываем окно сохранения
    }

	// Загружает содержимое файла и отображает его в Canvas
	function onFileLoaded(fileContent) {
		try {
			console.log("Загружено содержимое файла:", fileContent); // Лог для проверки содержимого
			const jsonData = JSON.parse(fileContent);  // Преобразуем содержимое JSON-файла в объект
			textContent = jsonData.objects.join("\n"); // Предположим, что "objects" хранит строки текста
			wrapText(textContent);  // Обрабатываем текст для переноса строк
			renderCanvas();  // Отображаем текст в Canvas
		} catch (e) {
			console.error("Ошибка при чтении файла:", e);
		}
	}

    // Скрыть окно с вопросом о сохранении
    function hideSaveWindow() {
        document.getElementById("exit").style.display = "none"; // Прячем окно сохранения
    }

    // Инициализация: загрузка списка файлов при открытии страницы
    android.getAllJsonFiles();  // Чтение всех файлов через Android-интерфейс
</script>

</body>
</html>
